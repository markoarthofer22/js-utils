name: npm-publish
on:
  workflow_run:
      workflows: ['Publish tags']
      branches: [main]
      types:
          - completed
      paths-ignore:
          - 'package.json'
          - '.github/**'
          - '*.md'
jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # Publish to npm Package Registry
      - name: Checkout Repo
        uses: actions/checkout@main

      - name: Store package name
        run: |
          echo 'package_name<<EOF' >> $GITHUB_ENV
          grep -Po '"name": *\K"[^"]*"' package.json | grep -oP '"\K[^"\047]+(?=["\047])' >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Setup Node.js (GPR)
        uses: actions/setup-node@master
        with:
          node-version: '14.x'
          registry-url: 'https://registry.npmjs.org/'
          scope: '@markoarthofer22'

      - name: Install dependencies
        run: npm install
        env:
          CI: true

      - name: Build new lib
        run: npm run build

       - name: Publish package
              run: 'npm publish --access public'
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.PUBLISH_KEY }}
